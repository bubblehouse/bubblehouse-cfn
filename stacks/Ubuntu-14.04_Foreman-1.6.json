{
    "Description": "org.bubblehouse.cloudformation.stacks.Ubuntu-14.04_Foreman-1.6@v0.0.1",
    
    "Parameters": {
        "InstanceHostName": {
            "Default": "$(facter ec2_hostname)",
            "Description": "Foreman instance hostname.",
            "Type": "String"
        },
        "InstanceNameTag": {
            "Default": "puppet-foreman",
            "Description": "'Name' tag for instance.",
            "Type": "String"
        },
        "KeyPairName": {
            "Default": "bubblehouse-master_20140323",
            "Description": "Name of an existing EC2 KeyPair to enable SSH access to the web server",
            "Type": "String"
        },
        "SecurityGroupIds": {
            "Default": "sg-6946510b",
            "Description": "Comma-separated list of security group IDs.",
            "Type": "CommaDelimitedList"
        },
        "SubnetId": {
            "Default": "subnet-f0706684",
            "AllowedPattern": "subnet-[a-z0-9]{8}",
            "ConstraintDescription": "must be a valid Amazon VPC subnet ID.",
            "Description": "VPC Subnet to deploy this instance to.",
            "Type": "String"
        },
        "StackDescription": {
            "Default": "EC2 Instance",
            "Description": "Description of this stack.",
            "Type": "String"
        },
        "SelectedImageId": {
            "Default": "ami-864d84ee",
            "Description": "The ID of an Ubuntu LTS 14.04 AMI to boot from.",
            "Type": "String"
        },
        "InstanceType": {
            "Default": "t2.medium",
            "Description": "EC2 instance type, e.g. m1.small, m1.large, etc.",
            "Type": "String"
        }
    },
    
    "Outputs": {
        "InstanceId": { "Value": { "Ref": "ec2" } },
        "PublicIP": { "Value": { "Ref": "eip" } }
    },
    
    "Resources": {
        "eip": {
            "Type": "AWS::EC2::EIP",
            "Properties": {
                "Domain": "vpc",
                "InstanceId": { "Ref": "ec2" }
            }
        },
        "ec2": {
            "Type": "AWS::EC2::Instance",
            "Properties": {
                "InstanceType": { "Ref": "InstanceType" },
                "Tags": [
                    { "Key": "Name", "Value": { "Ref": "InstanceNameTag" } }
                ],
                "ImageId": { "Ref": "SelectedImageId" },
                "SubnetId": { "Ref": "SubnetId" },
                "SecurityGroupIds": { "Ref": "SecurityGroupIds" },
                "KeyName": { "Ref": "KeyPairName" },
                "UserData": {
                    "Fn::Base64": { "Fn::Join": ["\n", [
                        "#!/bin/bash -ex",
                        "echo \"%admin ALL=(ALL) NOPASSWD: ALL\" > /etc/sudoers.d/99-sudo-nopwd-admins",
                        "chmod 0440 /etc/sudoers.d/99-sudo-nopwd-admins",
                        "apt-get update",
                        "apt-get install -y python-pip",
                        "pip install https://s3.amazonaws.com/cloudformation-examples/aws-cfn-bootstrap-latest.tar.gz",
                        {"Fn::Join": [" ", [
                            "cfn-init -v -c provision -s", { "Ref": "AWS::StackName" }, "--region", { "Ref": "AWS::Region" }, "-r ec2"
                        ]]}
                    ]]}
                }
            },
            "Metadata": {
                "AWS::CloudFormation::Init": {
                    "configSets": {
                        "provision": [ "configure-hostname", "install-puppet", "install-foreman" ]
                    },
                    "configure-hostname": {
                        "commands": {
                            "0001_modify-etc-hostname": {
                                "command": { "Fn:Join": ["", ["echo \"", { "Ref": "InstanceHostName" }, "\" > /etc/hostname"]] }
                            },
                            "0002_modify-etc-hosts": {
                                "command": "echo \"127.0.1.1 $(cat /etc/hostname) $(cat /etc/hostname | cut -d . -f 1)\" >> /etc/hosts"
                            }
                        }
                    },
                    "install-puppet": {
                        "commands": {
                            "0001_puppet-wget-deb": {
                                "command": "wget http://apt.puppetlabs.com/puppetlabs-release-trusty.deb",
                                "cwd": "/tmp"
                            },
                            "0002_puppet-dpkg-install": {
                                "command": "dpkg -i puppetlabs-release-trusty.deb",
                                "cwd": "/tmp"
                            },
                            "0003_puppet-apt-get-update": {
                                "command": "apt-get update"
                            },
                            "0004_puppet-apt-get-install-puppet": {
                                "command": "apt-get install -y puppet"
                            }
                        }
                    },
                    "install-foreman": {
                        "commands": {
                            "0001_foreman-source-create-base": {
                                "command": "echo \"deb http://deb.theforeman.org/ trusty 1.6\" > /etc/apt/sources.list.d/foreman.list"
                            },
                            "0002_foreman-source-append-plugins": {
                                "command": "echo \"deb http://deb.theforeman.org/ plugins 1.6\" >> /etc/apt/sources.list.d/foreman.list"
                            },
                            "0003_foreman-source-install-key": {
                                "command": "wget -q http://deb.theforeman.org/pubkey.gpg -O- | apt-key add -"
                            },
                            "0004_foreman-apt-get-update": {
                                "command": "apt-get update"
                            },
                            "0005_foreman-source-install-key": {
                                "command": "apt-get install -y foreman-installer"
                            },
                            "0006_foreman-install": {
                                "command": "foreman-installer"
                            }
                        }
                    }
                }
            }
        }
    },
    
    "AWSTemplateFormatVersion": "2010-09-09"
}
